---
title: "Bank Data Analysis"
format: html
editor: visual
execute: 
  echo: false
---

```{r echo=FALSE, message=FALSE, warning= FALSE}

library(tidyverse)
library(tidymodels)
library(lubridate)
library(scales)
library(ggcorrplot)
library(rstatix)
library(gt)
```

```{r message=FALSE , echo = FALSE}
Data <- readRDS("cleaned_data.rds")
Dataframe_base <- read_csv2("bank-full.csv")
```

```{r}
#colSums(is.na(Data)) #Sprawdzenie braków danych
```

## Eksploracja danych

### Distribution of customers' ages: What is the distribution of customers' ages? Are there any dominant age groups?

```{r}
# Data %>%
#   count(age, sort = TRUE)

Data |>
  ggplot(aes(x = age)) +
  geom_histogram(bins = 78) + 
  scale_x_continuous(breaks = seq(18,95,by=5)) +
  theme_bw()
 
```

Najwięcej klientów banku jest w wieku 32 lat. Występuje nagły spadek klientów w wieku powyżej 60 lat.

### Relationship between age and deposit subscription: Is there a connection between age and subscribing to a deposit? Are certain age groups more inclined towards subscribing?

```{r}
Data %>%
  group_by(age) %>%
  ggplot(aes(x = age, fill = y)) +
  geom_bar(position = "fill") +
  labs(x = NULL, y = "Proportion of term deposit subscriptions", fill = "Has the client subscribed a term deposit?") +
  theme_bw()+
  theme(legend.position = "bottom")
```

Istnieje związek pomiędzy wiekiem, a skłonnością do zakładania lokat. Młodzi oraz seniorzy są bardziej skłonni do zakładania lokat w porównaniu do osób w średnim wieku.

Conclusions: There appears to be a correlation between age and subscribing to a deposit. Younger Adults and Seniors show a higher inclination towards subscribing to deposits compared to Middle-Aged and Older Adults.

### Annual balance and subscription: Is the average annual balance of clients connected to deposit subscription?

```{r}
Data %>%
  group_by(y) %>%
  summarise(avg_balance = mean(balance)) %>%
  ggplot(aes(x = y, y = avg_balance, fill = y)) +
  geom_bar(stat = "identity")+
  theme_bw()
```

Osoby z większym saldem konta mają większą skłonność do pozostawienia pieniędzy na lokacie.

### Contact duration and subscription: Does the duration of the last contact relate to deposit subscription?

```{r}
Data %>%
  mutate(
    duration = duration / 60,
    duration_group = cut(duration, breaks = c(-1, 5, 15, max(duration) + 1), labels = c("Short", "Long", "Very long")), right = TRUE
  ) %>%
  group_by(duration_group) %>%
  ggplot(aes(x = duration_group, fill = y)) +
  geom_bar(position = "dodge")+
  theme_bw()

```

Widać, że jest sporo więcej krótszych rozmów, Wydaje się, że istnieje związek pomiędzy czasem trwania ostatniego kontaktu a subskrypcją. Dłuższe kontakty mają zwykle większą liczbę subskrypcji w porównaniu do krótszych kontaktów.

### Is there a correlation between outcome of the prevoius campaign and the subscription to a term deposit in the current campaign?

```{r}
Data %>%
  filter(poutcome != "unknown") %>% 
  ggplot(aes(x = poutcome, fill = y)) +
  geom_bar(position = "dodge")+
  theme_bw()
```

Oznacza to, że wynik poprzedniej kampanii może mieć wpływ na zachowania subskrypcyjne w bieżącej kampanii, co sugeruje związek między tymi zmiennymi.

### Is the marital status of clients (Marital) correlated with the subscription to a term deposit (Y)?

```{r}
Data %>%
  ggplot(aes(x = marital, fill = y)) +
  geom_bar(position = "fill")+
  theme_bw()
```

Nie ma tendencji wskazującej na silny związek pomiędzy stanem cywilnym a zapisaniem się na lokatę terminową

### How does the job status relate to the subscription of a term deposit?

```{r}
Data %>%
  ggplot(aes(x = job, fill = y)) +
  geom_bar(position = "fill") +
  facet_wrap(~job)+
  theme_bw()
```

Dane sugerują, że status stanowiska może mieć pewien wpływ na subskrypcję lokaty terminowej, o czym świadczy różna liczba wyników w różnych kategoriach stanowisk. Jednak ta relacja nie jest prosta ani spójna w przypadku wszystkich typów stanowisk, co wskazuje, że inne czynniki mogą również odgrywać rolę w określaniu zachowania subskrypcji.

### How does the education level relate to the subscription of a term deposit?

```{r}
Data %>%
  filter(education != "unknown") %>% 
  ggplot(aes(x = education, fill = y)) +
  geom_bar(position = "fill")+
  theme_bw()
```

Dane sugerują związek pomiędzy poziomem wykształcenia a abonamentem na lokatę terminową. Wydaje się, że wyższy poziom wykształcenia, zwłaszcza wyższego, wiąże się z większym prawdopodobieństwem zapisania się na lokatę terminową.

```{r}
d <- Dataframe_base %>% 
      mutate(y = ifelse(y == "yes", 1, 0))

Dataframe_numeric <- d[sapply(d, class) != "character"]
corr <- cor_mat(Dataframe_numeric)
p_mat <- cor_pmat(Dataframe_numeric)
ggcorrplot(corr, p.mat = p_mat,lab = T)
```

Poza czasem trwania rozmowy żadna zmienna numeryczna nie jest istotnie skorelowana z subskrybcją lokaty terminowej (y). Długość rozmowy może być znacząca, dlatego że może świadczyć o większym zainteresowaniu. Im dłużej prowadzona jest rozmowa tym bliższy jest temat konsumentowi przez co jest bardziej chętny do subskrypcji lokaty.

```{r}
#plyr::count(Data, "y")

ggplot(Data, aes(x=y))+
  geom_bar(fill = "lightgreen")+
  theme_bw()
```

## Budowa modeli

```{r}
load("wykresy/model_summary_table.rda")

summary_table |> 
  gt() |> 
  data_color(columns = 7,
             rows = c(1,2,3,5),
             palette = "#4bff4b",
             apply_to = "text") |> 
  data_color(columns = 6,
             rows = c(4,6),
             palette = "#4bff4b",
             apply_to = "text") |> 
  data_color(columns = 6,
             rows = c(1,2,3,5),
             palette = "red",
             apply_to = "text") |> 
  data_color(columns = 5,
             rows = c(6),
             palette = "red",
             apply_to = "text") |> 
  data_color(columns = 2,
             rows = c(4),
             palette = "red",
             apply_to = "text")
  
  
```

```{r}
load("wykresy/curve.rda")
curve 
```
